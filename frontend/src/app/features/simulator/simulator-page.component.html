<div class="simulator-container">
  <!-- Header -->
  <div class="simulator-header">
    <div class="header-left">
      <h1>
        <svg class="header-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
          <path d="M12 7V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 3L6 1M16 3L18 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Trading Simulator
      </h1>
      <p class="subtitle">Backtest your trading skills with real historical data</p>
    </div>
    <div class="step-indicator">
      <div class="step" [class.active]="currentStep === 'config'" [class.completed]="currentStep !== 'config'">
        <span class="step-number">1</span>
        <span class="step-label">Configure</span>
      </div>
      <div class="step-connector" [class.active]="currentStep !== 'config'"></div>
      <div class="step" [class.active]="currentStep === 'analysis'" [class.completed]="currentStep === 'results'">
        <span class="step-number">2</span>
        <span class="step-label">Analyze</span>
      </div>
      <div class="step-connector" [class.active]="currentStep === 'results'"></div>
      <div class="step" [class.active]="currentStep === 'results'">
        <span class="step-number">3</span>
        <span class="step-label">Results</span>
      </div>
    </div>
  </div>

  <div class="main-layout">
    <!-- Left Sidebar: Pair Selector + Configuration -->
    <div class="sidebar">
      <!-- Pair Selector -->
      <div class="panel pair-panel">
        <h3>
          <svg class="panel-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2"/>
            <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Select Pair
        </h3>
        <div class="pair-list" *ngIf="marketData$ | async as market">
          <div *ngIf="market.prices; else loading">
            <div 
              class="pair-item" 
              *ngFor="let item of market.prices | keyvalue"
              (click)="selectPair(item.key)"
              [class.selected]="item.key === selectedPair">
              <div class="pair-symbol">{{ item.key.replace('-', '/') }}</div>
              <div class="pair-price">{{ item.value.price | number:'1.2-4' }}</div>
              <div 
                class="pair-change"
                [ngClass]="{
                  'positive': item.value.change_percent >= 0, 
                  'negative': item.value.change_percent < 0
                }">
                {{ (item.value.change_percent / 100) | percent:'1.2-2' }}
              </div>
            </div>
          </div>
          <ng-template #loading>
            <div class="loading-text">Loading pairs...</div>
          </ng-template>
        </div>
      </div>

      <!-- Configuration Panel -->
      <div class="panel config-panel" *ngIf="currentStep === 'config'">
        <h3>
          <svg class="panel-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Select Period
        </h3>
        <div class="form-group">
          <label>Start Date</label>
          <input 
            type="date" 
            [(ngModel)]="startDate" 
            (change)="onDateChange()"
            class="date-input">
        </div>
        <div class="form-group">
          <label>End Date</label>
          <input 
            type="date" 
            [(ngModel)]="endDate" 
            (change)="onDateChange()"
            class="date-input">
        </div>
        <button class="btn-primary" (click)="startSimulation()" [disabled]="isLoading">
          <svg *ngIf="!isLoading" class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <polygon points="5,3 19,12 5,21" fill="currentColor"/>
          </svg>
          <span *ngIf="!isLoading">Start Simulation</span>
          <span *ngIf="isLoading">Loading...</span>
        </button>
        <p class="info-text">
          You'll analyze the chart before the start date and predict what happens between start and end date.
        </p>
      </div>

      <!-- Position Form (Analysis Step) -->
      <div class="panel position-panel" *ngIf="currentStep === 'analysis'">
        <h3>
          <svg class="panel-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 3V21H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M7 14L11 10L15 12L20 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Open Position
        </h3>
        <p class="instruction">Analyze the visible chart and set your trade parameters:</p>
        
        <div class="form-group">
          <label>Entry Price</label>
          <input 
            type="number" 
            [(ngModel)]="entryPrice" 
            (ngModelChange)="updatePriceLines()"
            step="0.01"
            class="price-input">
        </div>
        
        <div class="form-group">
          <label>Stop Loss (SL)</label>
          <input 
            type="number" 
            [(ngModel)]="stopLoss" 
            (ngModelChange)="updatePriceLines()"
            step="0.01"
            class="price-input sl-input">
        </div>
        
        <div class="form-group">
          <label>Take Profit (TP)</label>
          <input 
            type="number" 
            [(ngModel)]="takeProfit" 
            (ngModelChange)="updatePriceLines()"
            step="0.01"
            class="price-input tp-input">
        </div>

        <div class="position-summary" *ngIf="entryPrice > 0">
          <div class="summary-row">
            <span>Risk (to SL):</span>
            <span class="negative">{{ ((entryPrice - stopLoss) / entryPrice * 100) | number:'1.2-2' }}%</span>
          </div>
          <div class="summary-row">
            <span>Reward (to TP):</span>
            <span class="positive">{{ ((takeProfit - entryPrice) / entryPrice * 100) | number:'1.2-2' }}%</span>
          </div>
          <div class="summary-row">
            <span>Risk:Reward:</span>
            <span>1:{{ ((takeProfit - entryPrice) / (entryPrice - stopLoss)) | number:'1.2-2' }}</span>
          </div>
        </div>

        <button class="btn-reveal" (click)="showResults()" [disabled]="isLoading">
          <svg *ngIf="!isLoading" class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
            <path d="M2 12C4 7 7.5 4 12 4C16.5 4 20 7 22 12C20 17 16.5 20 12 20C7.5 20 4 17 2 12Z" stroke="currentColor" stroke-width="2"/>
          </svg>
          <span *ngIf="!isLoading">Show Results</span>
          <span *ngIf="isLoading">Calculating...</span>
        </button>
      </div>

      <!-- Results Panel -->
      <div class="panel results-panel" *ngIf="currentStep === 'results' && simulationResult">
        <h3 [class.win]="simulationResult.is_win" [class.loss]="!simulationResult.is_win">
          <svg *ngIf="simulationResult.is_win" class="panel-icon win-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M8 12L11 15L16 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <svg *ngIf="!simulationResult.is_win" class="panel-icon loss-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M15 9L9 15M9 9L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          {{ simulationResult.is_win ? 'Trade Won!' : 'Trade Lost' }}
        </h3>
        
        <div class="result-card" [class.win]="simulationResult.is_win" [class.loss]="!simulationResult.is_win">
          <div class="result-pnl">
            <span class="label">PnL</span>
            <span class="value" [class.positive]="simulationResult.pnl_percent >= 0" [class.negative]="simulationResult.pnl_percent < 0">
              {{ simulationResult.pnl_percent >= 0 ? '+' : '' }}{{ simulationResult.pnl_percent | number:'1.2-2' }}%
            </span>
          </div>
          <div class="result-details">
            <div class="detail-row">
              <span>Exit Type:</span>
              <span class="hit-type" [class.tp]="simulationResult.hit_type === 'TP'" [class.sl]="simulationResult.hit_type === 'SL'">
                {{ simulationResult.hit_type === 'TP' ? 'Take Profit' : simulationResult.hit_type === 'SL' ? 'Stop Loss' : 'Period End' }}
              </span>
            </div>
            <div class="detail-row">
              <span>Exit Price:</span>
              <span>{{ simulationResult.exit_price | number:'1.2-4' }}</span>
            </div>
          </div>
          <p class="result-message">{{ simulationResult.message }}</p>
        </div>

        <div class="result-actions">
          <button class="btn-save" (click)="saveResult()" [disabled]="isLoading">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M19 21H5C4 21 3 20 3 19V5C3 4 4 3 5 3H16L21 8V19C21 20 20 21 19 21Z" stroke="currentColor" stroke-width="2"/>
              <path d="M17 21V13H7V21M7 3V8H14" stroke="currentColor" stroke-width="2"/>
            </svg>
            Save to Leaderboard
          </button>
          <button class="btn-reset" (click)="resetSimulation()">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 4V10H7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M3.51 15C4.15 17.54 5.81 19.72 8.09 20.94C10.38 22.16 13.06 22.32 15.47 21.39C17.88 20.45 19.82 18.51 20.77 16.1C21.72 13.68 21.57 10.99 20.36 8.7C19.15 6.41 16.98 4.74 14.45 4.09C11.92 3.44 9.23 3.87 7 5.29L1 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Try Again
          </button>
        </div>
      </div>

      <!-- Error Display -->
      <div class="error-message" *ngIf="errorMessage">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
          <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        {{ errorMessage }}
      </div>
    </div>

    <!-- Main Content: Chart + Leaderboard -->
    <div class="main-content">
      <!-- Chart Section -->
      <div class="chart-section">
        <div class="chart-header">
          <div class="chart-title">
            <span class="symbol">{{ selectedPair.replace('-', '/') }}</span>
            <span class="timeframe-badge">{{ activeTimeframe }}</span>
            <span class="chart-status" *ngIf="currentStep === 'analysis'">
              <svg class="status-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Analyzing (data after {{ startDate }} is hidden)
            </span>
            <span class="chart-status revealed" *ngIf="currentStep === 'results'">
              <svg class="status-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <path d="M8 12L11 15L16 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Full data revealed
            </span>
          </div>
          <div class="timeframe-selector">
            <button 
              *ngFor="let tf of timeframes"
              class="tf-btn"
              [class.active]="tf === activeTimeframe"
              (click)="setTimeframe(tf)">
              {{ tf }}
            </button>
          </div>
        </div>
        <div #chartContainer class="chart-container">
          <div class="chart-loading" *ngIf="isLoading">
            <div class="spinner"></div>
            <span>Loading chart data...</span>
          </div>
          <div class="chart-placeholder" *ngIf="currentStep === 'config' && !isLoading">
            <svg class="placeholder-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 3V21H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M7 14L11 10L15 12L20 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <p>Configure your simulation and click "Start Simulation" to load the chart</p>
          </div>
        </div>
      </div>

      <!-- Leaderboard Section -->
      <div class="leaderboard-section">
        <div class="leaderboard-header">
          <h2>
            <svg class="leaderboard-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 21V11M16 21V7M12 21V3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M6 3L12 3M18 3L12 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Leaderboard
          </h2>
          <span class="leaderboard-subtitle">Top traders by PnL %</span>
        </div>
        
        <div class="leaderboard-table" *ngIf="!leaderboardLoading && leaderboard.length > 0">
          <div class="table-header">
            <span class="col-rank">#</span>
            <span class="col-user">User</span>
            <span class="col-pair">Pair</span>
            <span class="col-pnl">PnL %</span>
            <span class="col-date">Date</span>
          </div>
          <div class="table-body">
            <div 
              class="table-row" 
              *ngFor="let entry of leaderboard"
              [class.top-three]="entry.rank <= 3">
              <span class="col-rank">
                <span class="rank-badge" [class.gold]="entry.rank === 1" [class.silver]="entry.rank === 2" [class.bronze]="entry.rank === 3">
                  {{ entry.rank }}
                </span>
              </span>
              <span class="col-user">{{ entry.username }}</span>
              <span class="col-pair">{{ entry.pair }}</span>
              <span class="col-pnl" [class]="getPnlClass(entry.pnl_percent)">
                {{ entry.pnl_percent >= 0 ? '+' : '' }}{{ entry.pnl_percent | number:'1.2-2' }}%
              </span>
              <span class="col-date">{{ formatDate(entry.created_at) }}</span>
            </div>
          </div>
        </div>

        <div class="leaderboard-empty" *ngIf="!leaderboardLoading && leaderboard.length === 0">
          <svg class="empty-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M3 9H21M9 21V9" stroke="currentColor" stroke-width="2"/>
          </svg>
          <p>No results yet. Be the first to complete a simulation!</p>
        </div>

        <div class="leaderboard-loading" *ngIf="leaderboardLoading">
          <div class="spinner"></div>
          <span>Loading leaderboard...</span>
        </div>
      </div>
    </div>
  </div>
</div>
